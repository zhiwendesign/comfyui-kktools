# ComfyUI kktools 节点包完整使用指南

欢迎合作交流微信【XingYueAiArt】

## 📋 概述

kktools 是一个功能丰富的 ComfyUI 自定义节点包，包含图像处理、数学运算、提示词优化、尺寸生成和字符串处理五大模块，为工作流提供强大的扩展功能。

---

## 🖼️ 图像处理模块 (image.py)

### 1. Pad Image to Canvas (图像填充到画布)

#### 功能描述
将任意尺寸的图像放置到指定大小的画布上，支持自定义背景色和精确定位。

#### 核心参数
- **`width` / `height`**：画布尺寸（64-8192，步长8）
- **`fill_color`**：背景颜色（支持 #RGB、#RRGGBB、#RRGGBBAA 格式）
- **`center`**：居中开关
- **`left_padding` / `top_padding`**：自定义边距（支持负值）

#### 特色功能
- 支持透明背景（使用 #RRGGBBAA 格式）
- 自动处理 RGBA 透明度通道
- 批量处理支持

#### 使用场景
- 统一不同尺寸的图像分辨率
- 为图像添加彩色或透明背景
- 精确控制图像在画布中的位置

### 2. Image Frame (图像边框)

#### 功能描述
将 1-3 张图像进行并排显示，添加标签和边框，适合效果对比展示。

#### 核心参数
- **`image_count`**：显示图像数量（1-3 张）
- **`mode`**：排列方式（水平、垂直、网格）
- **`footer_height`**：底部标签区域高度
- **`font_size`**：标签文字大小
- **`font_selection`**：字体选择（支持自定义字体）

#### 布局模式
- **水平排列**：适合 1-2 张图像
- **垂直排列**：适合 1-3 张图像  
- **网格排列**：特别适合 3 张图像的 2×2 网格布局

#### 字体配置
在节点目录下的 `fonts` 文件夹中放入 `.ttf`、`.otf`、`.ttc` 格式的字体文件。

### 3. Resize (图像蒙版同步调整)

#### 功能描述
同时调整图像和对应蒙版的尺寸，确保两者尺寸完全一致。

#### 7种缩放模式
| 模式 | 描述 | 适用场景 |
|------|------|----------|
| **`stretch`** | 直接拉伸 | 需要精确尺寸，可接受变形 |
| **`scale_width`** | 按宽度等比缩放 | 固定宽度，高度自适应 |
| **`scale_height`** | 按高度等比缩放 | 固定高度，宽度自适应 |
| **`scale_long`** | 按长边等比缩放 | 保持比例，长边匹配目标 |
| **`scale_short`** | 按短边等比缩放 | 保持比例，短边匹配目标 |
| **`fit_padding`** | 等比缩放 + 填充 | 保持比例，填充空白区域 |
| **`fill_crop`** | 等比缩放 + 裁剪 | 保持比例，裁剪多余部分 |

#### 插值方法
- `nearest`：最近邻插值（保持边缘清晰）
- `bilinear`：双线性插值
- `bicubic`：双三次插值
- `lanczos`：兰索斯插值（最高质量）

### 4. Get Image (获取图像尺寸)

#### 功能描述
简单直接地获取图像的宽度和高度信息。

#### 输出
- **`width`**：图像宽度
- **`height`**：图像高度

#### 使用场景
- 动态调整工作流参数
- 调试和工作流优化

### 5. Batch Image Loader (批量图像加载)

#### 功能描述
从文件夹批量加载图像，支持多种排序、筛选和分批处理方式。

#### 加载控制
- **`load_order`**：加载顺序（顺序、倒序、随机）
- **`load_interval`**：加载间隔（隔N张加载1张）
- **`start_index`**：起始文件索引
- **`max_images`**：最大加载数量

#### 文件筛选
- **`file_extensions`**：文件类型（png、jpg、webp等）
- **`seed`**：随机种子（确保可重复性）
- **`batch_index`**：批次索引（支持大型数据集分批）

#### 输出
- **`images`**：图像张量
- **`masks`**：对应蒙版张量
- **`loaded_count`**：实际加载数量
- **`file_info`**：文件信息统计

---

## 🔢 数学运算模块 (Math.py)

### 1. 运算（数学表达式）

#### 功能描述
执行复杂数学运算，支持变量、函数和常量。

#### 内置函数库
| 类别 | 函数列表 |
|------|----------|
| **基本运算** | `add`, `sub`, `mul`, `div`, `pow`, `mod` |
| **比较运算** | `eq`, `ne`, `lt`, `le`, `gt`, `ge` |
| **数学函数** | `abs`, `round`, `min`, `max`, `sum` |
| **幂指对数** | `sqrt`, `exp`, `log`, `log10`, `log2` |
| **特殊函数** | `ceil`, `floor`, `trunc`, `fabs`, `factorial` |
| **数学常量** | `pi`, `e`, `tau`, `inf` |

#### 输入变量
- 支持 `a, b, c, d` 和 `x, y, z, w` 两种命名方式
- 可控制输出小数位数（0-10位）

#### 输出格式
- 浮点数结果
- 整数结果  
- 字符串结果

### 2. 运算（正则表达式）

#### 功能描述
使用正则表达式进行文本匹配和替换操作。

#### 操作模式
- **`match`**：从文本开头进行严格匹配
- **`search`**：在文本中搜索第一个匹配项
- **`findall`**：查找所有匹配项（换行分隔）
- **`replace`**：替换所有匹配的文本

### 3. 运算（正则表达式高级）

#### 增强功能
- **多标志支持**：
  - `IGNORECASE`：忽略大小写
  - `MULTILINE`：多行模式
  - `DOTALL`：点号匹配换行符

- **丰富输出**：
  - 匹配结果
  - 匹配数量
  - 匹配的文本内容
  - 操作详细信息

---

## 💬 提示词模块 (prompts.py)

### 1. Batch Prompt (批量提示词)

#### 功能描述
批量加载和处理提示词文件，支持单个文件和目录模式。

#### 文件模式
- **`single_file`**：单个文件（支持 .txt 和 .json 格式）
- **`directory`**：目录模式（读取目录下所有文本文件）

#### 批次控制
- **`batch_size`**：每批次提示词数量
- **`current_batch`**：当前批次索引

#### 输出
- 合并后的提示词
- 批次索引
- 总批次数
- 文件信息

### 2. AI Prompt Optimizer (AI提示词优化)

#### 功能描述
通过 DeepSeek API 优化提示词，提升生成质量。

#### 优化参数
- **`optimization_level`**：优化级别（轻度、中等、重度）
- **`target_style`**：目标风格（写实、动漫、艺术等）
- **`include_technical`**：是否包含技术细节
- **`max_length`**：最大长度限制

#### 使用要求
- 需要 DeepSeek API Key
- 支持参考提示词输入

#### 输出
- 优化后的提示词
- 原始提示词
- 优化信息

---

## 📐 尺寸生成模块 (size.py)

### 尺寸节点（尺寸生成）

#### 功能描述
生成不同比例和尺寸的 latent 张量，针对 SDXL 优化。

#### 尺寸模式
- **`preset`**：预设比例
  - 1:1 (1328×1328)
  - 16:9 (1664×928)
  - 9:16 (928×1664)
  - 4:3 (1472×1104)
  - 3:4 (1104×1472)
  - 3:2 (1584×1056)
  - 2:3 (1056×1584)

- **`custom`**：自定义尺寸

#### 输出
- Latent 张量
- 实际宽度
- 实际高度

#### 特性
- 自动确保尺寸为 8 的倍数
- 支持批量生成
- 针对 SDXL 优化的预设尺寸

---

## 📝 字符串处理模块 (string.py)

### 1. 字符串裁剪节点（基础裁剪）

#### 功能描述
忽略字符串开头和结尾指定数量的字符。

#### 参数
- **`skip_start`**：忽略开头的字符数
- **`skip_end`**：忽略结尾的字符数

#### 输出
裁剪后的字符串

### 2. 字符串裁剪节点（高级裁剪）

#### 增强功能
- 裁剪后的字符串
- 原始长度
- 裁剪后长度
- 移除的字符数

### 3. 字符串合并节点（字符串合并）

#### 功能描述
合并多个字符串，支持自定义分隔符。

#### 输入
- 最多 4 个字符串输入
- 可选分隔符

#### 输出
合并后的字符串

### 4. 输入节点（多类型输入）

#### 功能描述
可以输入 2 组字符串、整数或浮点数，自动类型转换。

#### 输入类型
- **`STRING`**：字符串
- **`INT`**：整数
- **`FLOAT`**：浮点数

#### 输出
每组输入都输出三种格式：
- 字符串格式
- 整数格式
- 浮点数格式

### 5. 替换节点（字符串替换）

#### 功能描述
替换字符串中的指定内容。

#### 参数
- **`old_text`**：要替换的文本
- **`new_text`**：替换为的文本
- **`replace_all`**：是否替换所有匹配项

#### 输出
- 替换后的字符串
- 替换次数

### 6. 类型转换节点（任意类型转换）

#### 功能描述
将任意输入转换为指定类型。

#### 支持类型
- **输入类型**：STRING、INT、FLOAT、BOOLEAN
- **输出类型**：STRING、INT、FLOAT

#### 特性
- 自动类型转换
- 错误处理
- 同时输出三种格式结果

---

## ⚠️ 通用注意事项

### 安全特性
- 数学表达式在沙盒环境中执行
- 只允许数学相关函数，禁用危险操作
- 完善的错误处理机制

### 性能优化
- 合理设置批量大小
- 选择适当的图像尺寸
- 使用合适的插值方法

### 错误处理
- 所有节点都有完善的异常处理
- 错误时返回默认值并显示错误信息
- 详细的控制台日志输出

### 兼容性
- 支持 ComfyUI 标准数据类型
- 批量处理支持
- 与其他节点良好集成

---

## 🎯 实用工作流示例

### 图像批量处理工作流
